<% content_for :title, "Showing server rack" %>

<div class="w-full max-w-7xl mx-auto">
  <% if notice.present? %>
    <p class="py-2 px-3 bg-green-50 mb-5 text-green-500 font-medium rounded-md inline-block" id="notice"><%= notice %></p>
  <% end %>

  <h1 class="font-bold text-4xl">Showing server rack</h1>

  <%= render @server_rack %>

  <%= link_to "Edit this server rack", edit_server_rack_path(@server_rack), class: "w-full sm:w-auto text-center rounded-md px-3.5 py-2.5 bg-blue-500 hover:bg-blue-600 inline-block font-medium text-white" %>
  <%= link_to "Back to server racks", server_racks_path, class: "w-full sm:w-auto text-center mt-2 sm:mt-0 sm:ml-2 rounded-md px-3.5 py-2.5 bg-gray-800 hover:bg-gray-700 inline-block font-medium text-white" %>
  <div class="sm:inline-block mt-2 sm:mt-0 sm:ml-2">
    <%= button_to "Destroy this server rack", @server_rack, method: :delete, class: "w-full rounded-md px-3.5 py-2.5 text-white bg-red-600 hover:bg-red-500 font-medium cursor-pointer", data: { turbo_confirm: "Are you sure?" } %>
  </div>

  <!-- Server Visualization (Centered) -->
  <div class="mt-8 flex justify-center">
    <div class="max-w-3xl w-full">
      <%= render "server_vizualization", server_rack: @server_rack %>
    </div>
  </div>
  
  <!-- Two-pane layout below visualization -->
  <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Left pane: Components in this Rack -->
    <div>
      <h2 class="text-2xl font-bold mb-4">Components in this Rack</h2>
      <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
        <% if @server_rack.rack_components.any? %>
          <div class="space-y-4">
            <% 
              # Group by position to show components in order
              @rack_components_by_position = @server_rack.rack_components
                .includes(:component)
                .order(:position_y)
                .group_by(&:position_y)
              
              # Generate colors for visual distinction
              position_colors = {
                # Define colors for rack positions (1-based)
                # We'll alternate subtle background colors
                even: "bg-gray-50 dark:bg-gray-800",
                odd: "bg-white dark:bg-gray-900"
              }
            %>
            
            <div class="overflow-hidden rounded-lg border border-gray-300 dark:border-gray-600">
              <table class="min-w-full divide-y divide-gray-300 dark:divide-gray-600">
                <thead class="bg-gray-100 dark:bg-gray-800">
                  <tr>
                    <th scope="col" class="py-2 px-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Position</th>
                    <th scope="col" class="py-2 px-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Component</th>
                    <th scope="col" class="py-2 px-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Details</th>
                    <th scope="col" class="py-2 px-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Actions</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                  <% @rack_components_by_position.each do |position, components| %>
                    <% components.each_with_index do |rack_component, index| %>
                      <tr class="<%= position.odd? ? position_colors[:odd] : position_colors[:even] %>">
                        <td class="py-3 px-3 whitespace-nowrap text-sm">
                          <% if index == 0 %> <!-- Only show position for first component in this position -->
                            <span class="font-medium"><%= position %>U</span>
                            <% if rack_component.component.height > 1 %>
                              <span class="text-gray-500 text-xs block">
                                spans <%= rack_component.component.height %>U 
                                (to position <%= position + rack_component.component.height - 1 %>)
                              </span>
                            <% end %>
                          <% end %>
                        </td>
                        <td class="py-3 px-3 whitespace-nowrap">
                          <div class="flex items-center">
                            <% 
                              # Same color logic as in visualization
                              component_name = rack_component.component.name.downcase
                              color_class = if component_name.include?('server')
                                "bg-blue-100 dark:bg-blue-900 border-blue-500"
                              elsif component_name.include?('network') || component_name.include?('switch') || component_name.include?('router')
                                "bg-green-100 dark:bg-green-900 border-green-500"
                              elsif component_name.include?('ups') || component_name.include?('power')
                                "bg-red-100 dark:bg-red-900 border-red-500"
                              elsif component_name.include?('storage') || component_name.include?('disk') || component_name.include?('nas')
                                "bg-yellow-100 dark:bg-yellow-900 border-yellow-500"
                              else
                                "bg-purple-100 dark:bg-purple-900 border-purple-500"
                              end
                            %>
                            <div class="h-6 w-6 rounded-full border <%= color_class %> mr-2"></div>
                            <div class="text-sm font-medium">
                              <%= link_to rack_component.component.name, component_path(rack_component.component), class: "hover:text-blue-500" %>
                            </div>
                          </div>
                        </td>
                        <td class="py-3 px-3 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                          <%= rack_component.component.height %>U • <%= rack_component.component.depth %> inches
                        </td>
                        <td class="py-3 px-3 whitespace-nowrap text-right">
                          <%= button_to "Remove", 
                            server_rack_rack_component_path(@server_rack, rack_component), 
                            method: :delete, 
                            class: "inline-flex items-center px-2.5 py-1.5 border border-transparent text-xs font-medium rounded text-red-700 bg-red-100 hover:bg-red-200 dark:text-red-100 dark:bg-red-800 dark:hover:bg-red-700 focus:outline-none",
                            form: { data: { turbo_confirm: "Are you sure you want to remove #{rack_component.component.name} from position #{rack_component.position_y}?" } } %>
                        </td>
                      </tr>
                    <% end %>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        <% else %>
          <p class="text-center py-8 text-gray-500">No components added to this rack yet.</p>
        <% end %>
      </div>
    </div>
    
    <!-- Right pane: Add Components -->
    <div>
      <h2 class="text-2xl font-bold mb-4">Add Components</h2>
      <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
        <h3 class="text-xl font-semibold mb-2">Search Components</h3>
        
        <% if Component.any? %>
          <!-- Search input -->
          <div class="mb-4">
            <label for="component-search" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              Search for a component
            </label>
            <div class="relative">
              <input type="text" id="component-search" 
                     placeholder="Type component name..." 
                     class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-white dark:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
              <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
              </div>
            </div>
          </div>
          
          <!-- Component selection -->
          <div class="mb-4" id="component-list">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              Select component
            </label>
            <div class="max-h-64 overflow-y-auto border border-gray-300 dark:border-gray-600 rounded-md">
              <ul class="divide-y divide-gray-300 dark:divide-gray-700">
                <% Component.all.each do |component| %>
                  <li class="component-item p-3 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer" 
                      data-name="<%= component.name.downcase %>"
                      data-id="<%= component.id %>"
                      data-height="<%= component.height %>"
                      data-depth="<%= component.depth %>"
                      onclick="selectComponent(this)">
                    <div class="flex items-center">
                      <% 
                        # Same color logic as in visualization
                        component_name = component.name.downcase
                        color_class = if component_name.include?('server')
                          "bg-blue-100 dark:bg-blue-900 border-blue-500"
                        elsif component_name.include?('network') || component_name.include?('switch') || component_name.include?('router')
                          "bg-green-100 dark:bg-green-900 border-green-500"
                        elsif component_name.include?('ups') || component_name.include?('power')
                          "bg-red-100 dark:bg-red-900 border-red-500"
                        elsif component_name.include?('storage') || component_name.include?('disk') || component_name.include?('nas')
                          "bg-yellow-100 dark:bg-yellow-900 border-yellow-500"
                        else
                          "bg-purple-100 dark:bg-purple-900 border-purple-500"
                        end
                      %>
                      <div class="h-6 w-6 rounded-full border <%= color_class %> mr-2"></div>
                      <div>
                        <h4 class="font-medium"><%= component.name %></h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400">
                          <%= component.height %>U • <%= component.depth %> inches
                        </p>
                      </div>
                    </div>
                  </li>
                <% end %>
              </ul>
              
              <!-- No results message, hidden by default -->
              <div id="no-results-message" class="hidden text-center py-4 text-gray-500">
                No components match your search. <%= link_to "Create a new component", new_component_path, class: "text-blue-500 hover:underline" %>
              </div>
            </div>
          </div>
          
          <!-- Position selector and add button, hidden until component selected -->
          <div id="position-selector" class="hidden">
            <div class="bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-md p-3 mb-4">
              <div class="flex items-center mb-2">
                <div id="selected-component-color" class="h-5 w-5 rounded-full mr-2"></div>
                <h4 id="selected-component-name" class="font-medium"></h4>
              </div>
              <p id="selected-component-details" class="text-sm text-gray-600 dark:text-gray-400 mb-3"></p>
              
              <%= form_with url: server_rack_rack_components_path(@server_rack), method: :post, id: "add-component-form", class: "flex flex-col sm:flex-row sm:items-end gap-3" do |form| %>
                <%= form.hidden_field :component_id, id: "selected-component-id" %>
                
                <div class="sm:w-2/3">
                  <div id="position-status" class="text-xs mb-1"></div>
                  <%= form.label :position_y, "Position (U):", class: "block text-sm font-medium text-gray-700 dark:text-gray-300" %>
                  <div class="mt-1 relative">
                    <%= form.number_field :position_y, 
                        id: "position-input",
                        min: 1, 
                        max: @server_rack.height,
                        value: 1, 
                        class: "block w-full rounded-md border-gray-300 dark:border-gray-700 dark:bg-gray-900 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" %>
                    
                    <div class="absolute inset-y-0 right-0 flex items-center pr-8">
                      <span id="position-indicator" class="text-xs"></span>
                    </div>
                  </div>
                </div>
                
                <div class="sm:w-1/3">
                  <%= form.submit "Add to Rack", id: "add-button", class: "w-full bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded shadow-sm disabled:opacity-50 disabled:cursor-not-allowed" %>
                </div>
              <% end %>
            </div>
            
            <div id="available-positions" class="hidden mb-2">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                Available positions:
              </label>
              <div class="flex flex-wrap gap-1" id="position-buttons"></div>
            </div>
          </div>
          
          <script>
            document.addEventListener('DOMContentLoaded', function() {
              const searchInput = document.getElementById('component-search');
              const componentItems = document.querySelectorAll('.component-item');
              const noResultsMessage = document.getElementById('no-results-message');
              const positionSelector = document.getElementById('position-selector');
              const availablePositions = document.getElementById('available-positions');
              const positionButtons = document.getElementById('position-buttons');
              const positionInput = document.getElementById('position-input');
              const positionStatus = document.getElementById('position-status');
              const positionIndicator = document.getElementById('position-indicator');
              const addButton = document.getElementById('add-button');
              const rackHeight = <%= @server_rack.height %>;
              
              // Handle search functionality
              searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                let visibleCount = 0;
                
                componentItems.forEach(item => {
                  const componentName = item.dataset.name;
                  const isVisible = componentName.includes(searchTerm);
                  
                  item.style.display = isVisible ? 'block' : 'none';
                  
                  if (isVisible) {
                    visibleCount++;
                  }
                });
                
                // Toggle no results message
                noResultsMessage.style.display = visibleCount === 0 ? 'block' : 'none';
              });
              
              // Check position availability when position changes
              positionInput.addEventListener('input', function() {
                checkPositionAvailability();
              });
            });
            
            // Global variables to track current component
            let currentComponentId = null;
            let currentComponentHeight = 0;
            let availablePositionsArray = [];
            
            function selectComponent(element) {
              // Get component data from clicked element
              const componentId = element.dataset.id;
              const componentName = element.querySelector('h4').innerText;
              const componentDetails = element.querySelector('p').innerText;
              const componentHeight = parseInt(element.dataset.height);
              const colorDiv = element.querySelector('div.rounded-full').cloneNode(true);
              
              // Update hidden form field
              document.getElementById('selected-component-id').value = componentId;
              
              // Update component display
              document.getElementById('selected-component-name').innerText = componentName;
              document.getElementById('selected-component-details').innerText = componentDetails;
              
              // Update color indicator
              const colorIndicator = document.getElementById('selected-component-color');
              colorIndicator.className = colorDiv.className;
              
              // Show position selector
              document.getElementById('position-selector').classList.remove('hidden');
              
              // Store current component data
              currentComponentId = componentId;
              currentComponentHeight = componentHeight;
              
              // Initialize position input
              const positionInput = document.getElementById('position-input');
              positionInput.max = <%= @server_rack.height %> - componentHeight + 1;
              positionInput.value = 1;
              
              // Check position availability
              checkPositionAvailability();
              
              // Highlight selected item and unhighlight others
              document.querySelectorAll('.component-item').forEach(item => {
                item.classList.remove('bg-blue-50', 'dark:bg-blue-900/30');
              });
              element.classList.add('bg-blue-50', 'dark:bg-blue-900/30');
            }
            
            function checkPositionAvailability() {
              if (!currentComponentId || !currentComponentHeight) return;
              
              const position = parseInt(document.getElementById('position-input').value);
              const rackHeight = <%= @server_rack.height %>;
              const endPosition = position + currentComponentHeight - 1;
              
              // Check if position is within bounds
              if (position < 1 || endPosition > rackHeight) {
                setPositionStatus('invalid', 'Position out of bounds');
                return;
              }
              
              // Make an AJAX request to check if position is available
              fetch(`<%= server_rack_path(@server_rack) %>/check_position?component_id=${currentComponentId}&position=${position}`)
                .then(response => response.json())
                .then(data => {
                  if (data.available) {
                    setPositionStatus('valid', 'Position available');
                    
                    // Show position range
                    document.getElementById('position-indicator').innerText = 
                      currentComponentHeight > 1 ? `(spans to ${endPosition}U)` : '';
                    
                  } else {
                    setPositionStatus('invalid', data.message || 'Position not available');
                  }
                });
            }
            
            function setPositionStatus(status, message) {
              const positionStatus = document.getElementById('position-status');
              const addButton = document.getElementById('add-button');
              
              if (status === 'valid') {
                positionStatus.className = 'text-xs text-green-600 dark:text-green-400 mb-1';
                positionStatus.innerText = '✓ ' + message;
                addButton.disabled = false;
              } else {
                positionStatus.className = 'text-xs text-red-600 dark:text-red-400 mb-1';
                positionStatus.innerText = '✗ ' + message;
                addButton.disabled = true;
              }
            }
          </script>
        <% else %>
          <p class="text-gray-500">No components available. <%= link_to "Create a component", new_component_path, class: "text-blue-500 hover:underline" %></p>
        <% end %>
      </div>
    </div>
  </div>
</div>
